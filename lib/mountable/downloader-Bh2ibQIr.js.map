{"version":3,"file":"downloader-Bh2ibQIr.js","sources":["../../../node_modules/native-file-system-adapter/src/adapters/downloader.js"],"sourcesContent":["import { errors } from '../util.js'\nimport config from '../config.js'\n\nconst {\n  WritableStream,\n  TransformStream,\n  DOMException,\n  Blob\n} = config\n\nconst { GONE } = errors\n// @ts-ignore - Don't match newer versions of Safari, but that's okay\nconst isOldSafari = /constructor/i.test(window.HTMLElement)\n\nexport class FileHandle {\n  constructor (name = 'unkown') {\n    this.name = name\n    this.kind = 'file'\n  }\n\n  async getFile () {\n    throw new DOMException(...GONE)\n  }\n\n  async isSameEntry(other) {\n    return this === other\n  }\n\n  /**\n   * @param {object} [options={}]\n   */\n  async createWritable (options = {}) {\n    const sw = await navigator.serviceWorker?.getRegistration()\n    const link = document.createElement('a')\n    const ts = new TransformStream()\n    const sink = ts.writable\n\n    link.download = this.name\n\n    if (isOldSafari || !sw) {\n      /** @type {Blob[]} */\n      let chunks = []\n      ts.readable.pipeTo(new WritableStream({\n        write (chunk) {\n          chunks.push(new Blob([chunk]))\n        },\n        close () {\n          const blob = new Blob(chunks, { type: 'application/octet-stream; charset=utf-8' })\n          chunks = []\n          link.href = URL.createObjectURL(blob)\n          link.click()\n          setTimeout(() => URL.revokeObjectURL(link.href), 10000)\n        }\n      }))\n    } else {\n      const { writable, readablePort } = new RemoteWritableStream(WritableStream)\n      // Make filename RFC5987 compatible\n      const fileName = encodeURIComponent(this.name).replace(/['()]/g, escape).replace(/\\*/g, '%2A')\n      const headers = {\n        'content-disposition': \"attachment; filename*=UTF-8''\" + fileName,\n        'content-type': 'application/octet-stream; charset=utf-8',\n        ...(options.size ? { 'content-length': options.size } : {})\n      }\n\n      const keepAlive = setTimeout(() => sw.active.postMessage(0), 10000)\n\n      ts.readable.pipeThrough(new TransformStream({\n        transform (chunk, ctrl) {\n          if (chunk instanceof Uint8Array) return ctrl.enqueue(chunk)\n          const reader = new Response(chunk).body.getReader()\n          const pump = _ => reader.read().then(e => e.done ? 0 : pump(ctrl.enqueue(e.value)))\n          return pump()\n        }\n      })).pipeTo(writable).finally(() => {\n        clearInterval(keepAlive)\n      })\n\n      // Transfer the stream to service worker\n      sw.active.postMessage({\n        url: sw.scope + fileName,\n        headers,\n        readablePort\n      }, [readablePort])\n\n      // Trigger the download with a hidden iframe\n      const iframe = document.createElement('iframe')\n      iframe.hidden = true\n      iframe.src = sw.scope + fileName\n      document.body.appendChild(iframe)\n    }\n\n    return sink.getWriter()\n  }\n}\n\n// Want to remove this postMessage hack, tell them u want transferable streams:\n// https://bugs.webkit.org/show_bug.cgi?id=215485\n\nconst WRITE = 0\nconst PULL = 0\nconst ERROR = 1\nconst ABORT = 1\nconst CLOSE = 2\n\nclass MessagePortSink {\n  /** @param {MessagePort} port */\n  constructor (port) {\n    port.onmessage = event => this._onMessage(event.data)\n    this._port = port\n    this._resetReady()\n  }\n\n  start (controller) {\n    this._controller = controller\n    // Apply initial backpressure\n    return this._readyPromise\n  }\n\n  write (chunk) {\n    const message = { type: WRITE, chunk }\n\n    // Send chunk\n    this._port.postMessage(message, [chunk.buffer])\n\n    // Assume backpressure after every write, until sender pulls\n    this._resetReady()\n\n    // Apply backpressure\n    return this._readyPromise\n  }\n\n  close () {\n    this._port.postMessage({ type: CLOSE })\n    this._port.close()\n  }\n\n  abort (reason) {\n    this._port.postMessage({ type: ABORT, reason })\n    this._port.close()\n  }\n\n  _onMessage (message) {\n    if (message.type === PULL) this._resolveReady()\n    if (message.type === ERROR) this._onError(message.reason)\n  }\n\n  _onError (reason) {\n    this._controller.error(reason)\n    this._rejectReady(reason)\n    this._port.close()\n  }\n\n  _resetReady () {\n    this._readyPromise = new Promise((resolve, reject) => {\n      this._readyResolve = resolve\n      this._readyReject = reject\n    })\n    this._readyPending = true\n  }\n\n  _resolveReady () {\n    this._readyResolve()\n    this._readyPending = false\n  }\n\n  _rejectReady (reason) {\n    if (!this._readyPending) this._resetReady()\n    this._readyPromise.catch(() => {})\n    this._readyReject(reason)\n    this._readyPending = false\n  }\n}\n\nclass RemoteWritableStream {\n  constructor (WritableStream) {\n    const channel = new MessageChannel()\n    this.readablePort = channel.port1\n    this.writable = new WritableStream(\n      new MessagePortSink(channel.port2)\n    )\n  }\n}\n"],"names":["WritableStream","TransformStream","DOMException","Blob","config","GONE","errors","isOldSafari","FileHandle","name","other","options","sw","link","ts","sink","chunks","chunk","blob","writable","readablePort","RemoteWritableStream","fileName","headers","keepAlive","ctrl","reader","pump","_","e","iframe","WRITE","PULL","ERROR","ABORT","CLOSE","MessagePortSink","port","event","controller","message","reason","resolve","reject","channel"],"mappings":"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","x_google_ignoreList":[0]}